var nwgui = require('nw.gui');
var extend = require('extend');
var lf = require('logfile');
var util = require('util');
var eventEmitter = require('events');
var CLOSED = 0;
var OPEN = 1;

function logWindow(config,category){
	eventEmitter.call(this);
	util.inherits(logWindow,eventEmitter);
	this.config = config;
	this.category = (typeof category != 'undefined') ? category : null;
	this.state = CLOSED;
	this.winRef;
	this.dom;
	this.on('open',function(ref){
		this.winRef = ref;
		this.winRef.setShowInTaskbar(false);
		var title = this.category ? this.category : 'Main Log';
		this.winRef.title(title);
		this.dom = ref.window;
		this.state = OPEN;
	});
	this.on('close',function(){
		this.winRef = null;
		this.dom = null;
		this.state = CLOSED;
	});
}

logWindow.prototype.open = function(){
	lf.read(this.category,this.config.logfile,function(reader){
		var winRef = nwgui.Window.open('logfile.html',this.config.window);
		this.emit('open',winRef,this);

		this.winRef.on('loaded',function(){
			while(reader.hasNextLine()){
				this.callWinFunction('fillLine',reader.nextLine());
			}
			this.emit('loaded',this);
		});
	});
};

logWindow.prototype.callWinFunction = function(){\
	if(this.winRef && this.dom){
		var func = Array.prototype.shift.call(arguments);
		return this.dom[func](arguments);
	}else{
		return false;
	}
};

logWindow.prototype.fillLine = function(line){
	this.callWinFunction('fillLine',line);
};

logWindow.prototype.close = function(){
	this.winRef.close();
	this.emit('close',this);
};

logWindow.prototype.capture = function(){
	this.winRef.capturePage(function(url){
		this.emit('captured',url);
	});
};

logWindow.prototype.focus = function(){
	this.winRef.focus();
};

module.exports = logWindow;