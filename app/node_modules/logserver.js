var qs = require('querystring');
function LogServer(port){
	this.sys = require('sys');
	this.svr = require('http');
	this.port = port;
}

LogServer.prototype.connect = function(callback){
	this.svr.createServer(function(request,response){
	    if(request.method == 'POST') {
	        processRequest(request, response, callback);
	    } else {
	        response.writeHead(200, "OK", {'Content-Type': 'text/plain'});
	        response.end();
	    }	  
	      
	}).listen(this.port);

	function processRequest(request,response,callback){
		if(typeof callback !== 'function') return null;

		body = '';
		console.log(request.method);
		if(request.method == 'POST'){
			request.on('data',function(data){
				body += data;
				if(body.length > 1e6) {
		            body = "";
		            response.writeHead(413, {'Content-Type': 'text/plain'}).end();
		            request.connection.destroy();
	            }
			});
			request.on('end', function() {
	            request.post = qs.parse(body);
	            response.end();
	            callback(request.post);
	        });
		}else{
			response.writeHead(405, {'Content-Type': 'text/plain'});
	        response.end();
		}
	}
}	

module.exports = LogServer;