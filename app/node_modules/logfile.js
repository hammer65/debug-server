var linereader = require('filelinereader');
var fs = require('fs');
var extend = require('extend');
var path = require('path');
var defaults = {
		logDir: './logs',
		newLine: true,
		fileName: 'log.txt',
		prependCat: true
	}
function isDir(path){
	var ret = false;
	try {
	    stats = fs.lstatSync(path);
	    if (stats.isDirectory()) {
	        ret = true;
	    }
	}
	catch (e) {
	    // ret remains false
	}
	return ret;
}

module.exports.write = function(message, category, options, callback){
	if(typeof options == 'undefined'){ options = {}; }
	if(typeof category == 'undefined'){ category = null; }
	message = ops['newLine'] ? message + "\n" : message;
	ops = extend(defaults,options);
	var dir = category ? ops['logDir'] + '/' + category : ops['logDir'];
	dir = path.resolve(dir);
	var filename = catagory && ops['prependCat'] ? category + '_' + ops['fileName'] : ops['fileName'];
	fs.mkdir(dir,function(e){
		if(e && e.code != 'EEXIST'){
			throw e;
		}
		filepath = dir + '/' + filename;
		fs.appendFile(filepath,message,function(e){
			if(e) throw e;
			//fs.readFile(filepath,'utf8',callback);
			callback(message);
		});

	});
}


module.exports.read = function(category, options, callback){
	if(typeof options == 'undefined'){ options = {}; }
	if(typeof category == 'undefined'){ category = null; }
	ops = extend(defaults,options);
	var dir = category ? ops['logDir'] + '/' + category : ops['logDir'];
	dir = path.resolve(dir);
	var filename = catagory && ops['prependCat'] ? category + '_' + ops['fileName'] : ops['fileName'];
	
	callback(new linereader(dir + '/' + filename));
}

module.exports.delete = function(category, options, callback){
	if(typeof options == 'undefined'){ options = {}; }
	if(typeof category == 'undefined'){ category = null; }
	ops = extend(defaults,options);
	var dir = category ? ops['logDir'] + '/' + category : ops['logDir'];
	dir = path.resolve(dir);
	var filename = catagory && ops['prependCat'] ? category + '_' + ops['fileName'] : ops['fileName'];

	fs.unlink(dir + '/' + filename,callback);
}

module.exports.list = function(category, options, callback){
	if(typeof options == 'undefined'){ options = {}; }
	if(!category || typeof category == 'undefined'){ category = null; }
	ops = extend(defaults,options);
	var dir = category ? ops['logDir'] + '/' + category : ops['logDir'];
	dir = path.resolve(dir);

	fs.readdir(dir,callback); 
}