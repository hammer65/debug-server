var loginWindow = require('logwindow');
var lf = require('logfile');
var util = require('util');
var eventEmitter = require('events');
var nwgui = require('nw.gui');

function application(config){
	eventEmitter.call(this);
	util.inherits(application,eventEmitter);
	this.config = config;
	this.windows = {};
	this.on('windowloaded'function(wObj,category){
		category = category ? category : 'GENERAL_CAT';
		this.windows[category] = wObj;
		wObj.on('close',function(w){
			var category = w.category ? w.category : 'GENERAL_CAT'
			delete this.windows[category]
		});
	});
	var win = nwgui.Window.get();
	this.mainWindow = {
		win: win,
		dom: win.window
	};
};

application.prototype.openLogWindow = function(category){
	var win = new logWindow(this.config.logWindow,category);
	win.on('loaded'function(window){
		this.emit('windowloaded',window,category);
	});
};

application.prototype.closeLogWindow = function(category){
	category = category ? category : 'GENERAL_CAT';
	if(typeof this.windows[category] != 'undefined'){
		this.windows[category].close();
		this.emit('windowclosed',category);
		return true;
	}else{
		return false;
	}
};

appication.prototype.focusWindow = function(category){
	category = category ? category : 'GENERAL_CAT';
	if(typeof this.windows[category] != 'undefined'){
		this.windows[category].focus();
	}
};

application.prototype.addLogLine = function(message,category){
	category = category ? category : 'GENERAL_CAT';
	if(typeof this.windows[category] != 'undefined'){
		this.windows[category].fillLine(message);
	}
};

application.prototype.quit = function(){
	this.emit('shutdown');
	if(this.config.hardShutdown){
		nwgui.App.quit();
	}else{
		nwgui.App.closeAllWindows();
	}
}

application.prototype.list = function(){
	lf.list(null,this.config.logs,function(e,data){
		if(e){ console.log(e); return false}
		var el = this.mainWindow.dom.$('#groups');
		var row, lnk, clear, del;
		for(var i = 0;i < data.length;i++){
			row = this.mainWindow.dom.$(
				'<div class="category"></div>');
			lnk = this.mainWindow.dom.$(
				'<a href="#" data-category="' + data[i] + '" id="cat_' + data[i] + '">' + data[i] + '</a>&nbsp;');
			lnk.click(function(event){
				var el = event.target;
				this.openLogWindow(el.getAttribute('data-category'));
				event.preventDefault();
			});
			clear = this.mainWindow.dom.$(
				'<a href="#" data-category="' + data[i] + '" id="clrcat_' + data[i] + '" class="clr-link">Clear</a>&nbsp;');
			clear.click(function(event){
				if(this.mainWindow.dom.confirm('Are you sure you want to clear this log?')){
					var el = event.target;
					this.clearLog(el.getAttribute('data-category'));
				}
			});
			del = this.mainWindow.dom.$(
				'<a href="#" data-category="' + data[i] + '" id="delcat_' + data[i] + '" class="del-link">Delete</a>'
				);
			del.click(function(event){
				if(this.mainWindow.confirm('Are you sure you want to delete this log?')){
					var el = event.target;
					this.deleteLog(el.getAttribute('data-category'));
				}

			});
			row.append(lnk);
			row.append(clear);
			row.append(del);
			el.append(row);
		}
	});
}

module.exports = application;