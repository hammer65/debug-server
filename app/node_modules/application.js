var logWindow = require('logwindow');
var lf = require('logfile');
var util = require('util');
var events = require('events');
var nwgui;

function application(config,gui){
	events.EventEmitter.call(this);
	this.config = config;
	console.log(typeof this.config);
	this.windows = {};
	this.blah = 'blah';
	nwgui = gui;
	this.on('windowloaded',function(wObj,category){
		category = category ? category : 'GENERAL_CAT';
		this.windows[category] = wObj;
		wObj.on('close',function(w){
			var category = w.category ? w.category : 'GENERAL_CAT'
			delete this.windows[category]
		});
	});
	var win = nwgui.Window.get();
	this.mainWindow = {
		win: win,
		dom: win.window
	};
}

util.inherits(application,events);

application.prototype.openLogWindow = function(category){
	var win = new logWindow(this.config.logWindow,category);
	win.on('loaded',function(window){
		this.emit('windowloaded',window,category);
	});
};

application.prototype.closeLogWindow = function(category){
	category = category ? category : 'GENERAL_CAT';
	if(typeof this.windows[category] != 'undefined'){
		this.windows[category].close();
		this.emit('windowclosed',category);
		return true;
	}else{
		return false;
	}
};

application.prototype.focusWindow = function(category){
	category = category ? category : 'GENERAL_CAT';
	if(typeof this.windows[category] != 'undefined'){
		this.windows[category].focus();
	}
};

application.prototype.addLogLine = function(message,category){
	category = category ? category : 'GENERAL_CAT';
	if(typeof this.windows[category] != 'undefined'){
		this.windows[category].fillLine(message);
	}
};

application.prototype.quit = function(){
	this.emit('shutdown');
	if(this.config.hardShutdown){
		nwgui.App.quit();
	}else{
		nwgui.App.closeAllWindows();
	}
}

application.prototype.list = function(){
	var app = this;
	lf.list(null,this.config.logs,function(e,data){
		if(e){ console.log(e.message); return false}
		var el = app.mainWindow.dom.$('#groups');
		var row, lnk, clear, del;
		for(var i = 0;i < data.length;i++){
			row = app.mainWindow.dom.$(
				'<div class="category"></div>');
			lnk = app.mainWindow.dom.$(
				'<a href="#" data-category="' + data[i] + '" id="cat_' + data[i] + '">' + data[i] + '</a>&nbsp;');
			lnk.click(function(event){
				var el = event.target;
				app.openLogWindow(el.getAttribute('data-category'));
				event.preventDefault();
			});
			/*clear = this.mainWindow.dom.$(
				'<a href="#" data-category="' + data[i] + '" id="clrcat_' + data[i] + '" class="clr-link">Clear</a>&nbsp;');
			clear.click(function(event){
				if(mw.dom.confirm('Are you sure you want to clear this log?')){
					var el = event.target;
					this.clearLog(el.getAttribute('data-category'));
				}
			});
			del = mw.dom.$(
				'<a href="#" data-category="' + data[i] + '" id="delcat_' + data[i] + '" class="del-link">Delete</a>'
				);
			del.click(function(event){
				if(mw.confirm('Are you sure you want to delete this log?')){
					var el = event.target;
					this.deleteLog(el.getAttribute('data-category'));
				}

			});*/
			row.append(lnk);
			row.append(clear);
			row.append(del);
			el.append(row);
		}
	});
}

module.exports = application;